const e={golbal_arr:{},scene_arr:{},line_arr:[],close_arr:{},note_arr:[],last_id:0,line_id:0,line_length:0,wall:1,scene:[],line:[],bag:[],key:{door:"",next:""},boss:0,heart:0,qte:0},v=document.querySelector("#screen"),h=document.querySelector("#screen_ui"),Q=document.querySelector("#screen_bg"),S=document.querySelector("#scene_ux"),r=document.querySelector("#scene_bg"),E=a("set_btn"),ee=a("next_scene_btn");v.appendChild(E);const k=a("end_div"),$=a("end_content"),X=a("end_share"),R=a("end_retry");k.append($,X,R);const N=a("lines_div"),A=a("lines_btn"),z=a("lines_txt"),_=(n,t)=>{switch(r.innerHTML="",S.innerHTML="",h.innerHTML="",t?e.scene=t[n]:e.scene=e.scene_arr[n],console.log("new",e.scene),e.scene.bg&&(r.className=e.scene.bg),e.line_arr[n]&&(e.line_length=e.line_arr[n].length),e.scene.type){case"anim":r.addEventListener("animationend",s=>{s.animationName===e.scene.bg&&e.scene.type==="anim"&&(r.className="",_(e.scene.next))});break;case"line":b(n);break;case"close":e.line_length=0,b(n);break;case"view":e.last_id=n,b(n);break;case"room":e.last_id=n,r.className=`${e.scene.bg}-${e.wall}`,e.line_arr[n][e.wall]?(e.line_length=e.line_arr[n][e.wall].length,b(e.wall,e.line_arr[n])):b(n);break;case"qte":r.className=`${e.scene.bg}-${e.qte}`,b(n);break;case"end":r.addEventListener("animationend",s=>{s.animationName===e.scene.bg&&e.scene.type==="end"&&(r.className="",r.innerHTML="",S.innerHTML="",h.innerHTML="",ee.click())});break}},b=(n,t)=>{if(h.innerHTML="",t?e.line=t[n]:e.scene.type==="room"||(e.line=e.line_arr[n]),e.line_length>0)z.textContent=e.line[e.line_id],N.innerHTML="",N.append(z,A),h.appendChild(N),e.line_id+=1;else switch(e.line_id=0,e.scene.type){case"line":_(e.scene.next);break;case"close":H(),ie();break;case"view":delete e.line_arr[n],H(),oe();break;case"room":delete e.line_arr[n][e.wall],H(),de();break;case"qte":delete e.line_arr[n],ae(),P(),_e();break}},H=()=>{let n=e.scene.ux;e.scene.type==="room"&&(n=e.scene.ux[e.wall-1]),n.forEach(t=>{if(e.bag.includes(t.item))return;const s=document.createElement("div");s.className="btns_ux",S.appendChild(s),s.style.left=t.x+"vh",s.style.top=t.y+"vh",s.style.width=t.w+"vh",s.style.height=t.h+"vh",s.style.background="blue",s.addEventListener("click",l=>{ne(l,t)})})},ne=(n,t)=>{switch(t.type){case"note":e.line_length=e.note_arr[t.is].length,b(t.is,e.note_arr);break;case"close":_(t.is,e.close_arr);break;case"item":e.bag.push(t.item),n.target.style.display="none";break;case"next":t.wall&&(e.wall=t.wall),_(t.is);break}},B=a("qte_div"),O=a("qte_btn","ui_btns"),te=a("qte_bar"),D=a("qte_box"),f=a("qte_dot"),x=a("feedback","gmui_btns"),L=a("userHeart"),q=a("bossHeart");let se=0;function ae(){e.qte=0,L.innerHTML="",q.innerHTML="",e.boss=e.scene.boss,e.heart=e.scene.user;for(let n=0;n<e.heart;n++){const t=a(0,"heart_icon");L.appendChild(t)}for(let n=0;n<e.boss;n++){const t=a(0,"boss_icon");q.appendChild(t)}}function P(){se=Date.now(),f.className="qte_start_anim",x.textContent="Press to move on"}function le(){const t=window.getComputedStyle(f).transform;f.className="",f.style.transform=t}function ce(n,t){const s=n.getBoundingClientRect(),l=t.getBoundingClientRect();return s.left>=l.left&&s.right<=l.right}function re(){const n=document.querySelector("#qte_bar");ce(f,n)?(x.textContent=e.golbal_arr.success,e.boss-=1,e.qte+=1,e.scene.mode==="fight"&&(r.className=`${e.scene.bg}-boss`),F("boss",q,e.boss)):(x.textContent=e.golbal_arr.failed,e.heart-=1,e.scene.mode==="fight"&&(r.className=`${e.scene.bg}-heart`),F("heart",L,e.heart)),le()}function F(n,t,s){const l=t.querySelectorAll(`.${n}_icon`),d=l.length-s;if(d>0)for(let o=0;o<d;o++){const u=l[l.length-1-o];u.classList.add("heart_out_anim"),u.addEventListener("animationend",()=>{u.remove(),e.boss<1?(e.scene.reward&&e.bag.push(e.scene.reward),e.scene.change&&e.scene.change.forEach(c=>{c.wall?(e.scene_arr[c.id].ux[c.wall-1][c.ux].type=c.type,e.scene_arr[c.id].ux[c.wall-1][c.ux].is=c.is):(e.scene_arr[c.id].ux[c.ux].type=c.type,e.scene_arr[c.id].ux[c.ux].is=c.is)}),_(e.scene.next)):e.heart<1?(v.appendChild(k),I(),E.style.zIndex=0,$.textContent=e.golbal_arr.end[e.scene.end]):(e.scene.mode==="run"?n==="boss"&&(r.className=`${e.scene.bg}-${e.qte}`):e.scene.mode==="fight"&&(r.className=`${e.scene.bg}-0`),P())})}else if(d<0)for(let o=0;o<Math.abs(d);o++){const u=a(n,`${n}-icon`);t.appendChild(u)}}R.addEventListener("click",()=>{I()});let T=!1;E.addEventListener("click",W(()=>{I()},300));const I=()=>{E.style.zIndex=11,T?v.removeChild(k):(v.appendChild(k),$.textContent=e.golbal_arr.end[0][0],X.textContent=e.golbal_arr.end[0][1],R.textContent=e.golbal_arr.end[0][2]),T=!T},Y=a("btn_return","ui_btns"),m=a("btn_bag","ui_btns"),j=a("btn_left","ui_btns"),G=a("btn_right","ui_btns");A.addEventListener("click",W(()=>{e.line_length-=1,b(e.scene.id)},300));const oe=()=>{h.append(m)},ie=()=>{h.append(Y,m)};Y.addEventListener("click",()=>{_(e.last_id)});const de=()=>{h.append(j,G,m)};j.addEventListener("click",()=>{e.wall>1?e.wall-=1:e.wall=4,_(e.scene.id)});G.addEventListener("click",()=>{e.wall<4?e.wall+=1:e.wall=1,_(e.scene.id)});const _e=()=>{D.appendChild(te),B.append(L,q,x,D,f,O),h.appendChild(B)};O.addEventListener("click",()=>re());const y=a("bag_div"),p=a("bag_slots","bag_slots_close"),g=a("bag_view"),J=a("bag_slots_btn"),K=a("bag_key_btn");let M=!1,C=!1;m.addEventListener("click",W(()=>{M?Q.removeChild(y):U(),M=!M},300));const U=()=>{y.innerHTML="",p.innerHTML="",y.append(g,p,J),e.bag.forEach((n,t)=>{const s=a(e.golbal_arr.item[n].bg,"bag_icon");s.draggable=!0,he(s,n),p.appendChild(s),s.addEventListener("click",()=>{g.innerHTML="",g.className!==e.golbal_arr.item[n].bg?(g.className=e.golbal_arr.item[n].bg,e.golbal_arr.item[n].type==="key"&&(g.appendChild(K),e.key.door=e.golbal_arr.item[n].door,e.key.next=e.golbal_arr.item[n].next)):g.className=""})}),Q.appendChild(y)};J.addEventListener("click",()=>{C?be():ge()});K.addEventListener("click",()=>{r.className===e.key.door&&(_(e.key.next),m.click())});const be=()=>{C=!1,g.style.height="100%",p.className="bag_slots_close"},ge=()=>{C=!0,g.style.height="0%",p.className="bag_slots_open"};let i=null,w=null;function he(n,t){n.addEventListener("touchstart",function(s){C&&(i=n,w=t)}),n.addEventListener("touchmove",function(s){if(!i)return;i.style.position="absolute";var l=s.targetTouches[0];const d=parseFloat(window.getComputedStyle(i).width),o=parseFloat(window.getComputedStyle(i).height);i.style.left=l.screenX-window.innerWidth/2+d*1.2+"px",i.style.top=l.screenY-window.innerHeight/2+o*1.2+"px"}),n.addEventListener("touchend",function(s){if(!i)return;const l=Math.floor((s.changedTouches[0].pageX-p.offsetLeft)/i.offsetWidth),d=Math.max(0,Math.min(e.bag.length-1,l)),o=e.bag[w];e.bag[w]=e.bag[d],e.bag[d]=o;const u=e.bag.filter((c,V,Z)=>c!==void 0&&c!==""&&Z.indexOf(c)===V);e.bag=u,U(),i=null,w=null})}function a(n,t,s){const l=document.createElement("div");return n&&(l.id=n),t&&(l.className=t),l}function W(n,t=100){let s;return(...l)=>{clearTimeout(s),s=setTimeout(()=>n.apply(this,l),t)}}export{ne as click_ux,R as end_retry,b as new_line,_ as new_scene,ee as next_scene_btn,H as render_ux,e as user};
