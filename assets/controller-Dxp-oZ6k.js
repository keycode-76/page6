const e={card:[],message:0,scene_arr:{},line_arr:[],close_arr:{},note_arr:[],last_id:0,line_id:0,line_length:0,wall:1,scene:[],line:[],bag:[0,1,2],key:{door:"",next:""},boss:3,heart:3},u=document.querySelector("#screen_ui"),X=document.querySelector("#screen_bg"),v=document.querySelector("#scene_ux"),b=document.querySelector("#scene_bg"),q=a("lines_div"),D=a("lines_btn"),N=a("lines_txt");a("jump_note");const M=a("end_div"),H=a("end_content"),T=a("end_retry"),l=(t,n)=>{switch(b.innerHTML="",v.innerHTML="",u.innerHTML="",n?e.scene=n[t]:e.scene=e.scene_arr[t],e.scene.bg&&(b.className=e.scene.bg),b.className=e.scene.bg,e.line_arr[t]&&(e.line_length=e.line_arr[t].length),e.scene.type){case"anim":document.addEventListener("animationend",s=>{s.animationName===e.scene.bg&&(b.className="",l(e.scene.next))});break;case"line":i(t);break;case"close":e.line_length=0,i(t);break;case"view":e.last_id=t,i(t);break;case"room":b.className=`${e.scene.bg}-${e.wall}`,e.line_arr[t][e.wall]?(e.line_length=e.line_arr[t][e.wall].length,i(e.wall,e.line_arr[t])):i(t);break;case"qte":i(t);break}},i=(t,n)=>{if(u.innerHTML="",n?(e.line=n[t],e.line_length=1):e.line=e.line_arr[t],e.line_length>0)N.textContent=e.line[e.line_id],q.innerHTML="",q.append(N,D),u.appendChild(q),e.line_id+=1;else switch(e.line_id=0,e.scene.type){case"line":l(e.scene.next);break;case"close":te();break;case"view":delete e.line_arr[t],S(),ee();break;case"room":delete e.line_arr[t][e.wall],S(),ne();break;case"qte":Z(),Q(),se();break}},S=()=>{let t=e.scene.ux;e.scene.type==="room"&&(t=e.scene.ux[e.wall-1]),t.forEach(n=>{if(e.bag.includes(n.item))return;const s=document.createElement("div");s.className="btns_ux",v.appendChild(s),s.style.left=n.x+"vh",s.style.top=n.y+"vh",s.style.width=n.w+"vh",s.style.height=n.h+"vh",s.style.background="blue",s.addEventListener("click",c=>{G(c,n)})})},G=(t,n)=>{switch(n.type){case"line":i(n.note,e.note_arr);break;case"close":l(n.close,e.close_arr);break;case"item":e.bag.push(n.item),t.target.style.display="none";break;case"next":l(n.next);break}},R=a("qte_div"),I=a("qte_btn","ui_btns"),J=a("qte_bar"),$=a("qte_box"),g=a("qte_dot"),w=a("feedback","gmui_btns"),L=a("userHeart"),x=a("bossHeart");let K=0;function Q(){K=Date.now(),g.className="qte_start_anim",w.textContent="Press to move on"}function O(){const t=window.getComputedStyle(g),n=t.transform,s=t.backgroundColor;g.className="",g.style.transform=n,g.style.backgroundColor=s}function U(t,n){const s=t.getBoundingClientRect(),c=n.getBoundingClientRect();return s.left>=c.left&&s.right<=c.right}function V(){const t=document.querySelector("#qte_bar");U(g,t)?(w.textContent="成功！",e.boss-1<1?l(e.scene.win):(e.boss-=1,B("boss",x,e.boss))):(w.textContent="失敗！",e.heart-1<1?(b.className="",v.innerHTML="",v.appendChild(M),M.append(H,T),H.textContent="結局一",T.textContent="重新開局"):(e.heart-=1,B("heart",L,e.heart))),O()}function B(t,n,s){const c=n.querySelectorAll(`.${t}_icon`),d=c.length-s;if(d>0)for(let o=0;o<d;o++){const p=c[c.length-1-o];p.classList.add("heart_out_anim"),p.addEventListener("animationend",()=>{p.remove(),Q()})}else if(d<0)for(let o=0;o<Math.abs(d);o++){const p=a(t,`${t}-icon`);n.appendChild(p)}}function Z(){L.innerHTML="",x.innerHTML="",e.boss=e.scene.boss,e.heart=e.scene.user;for(let t=0;t<e.heart;t++){const n=a(0,"heart_icon");L.appendChild(n)}for(let t=0;t<e.boss;t++){const n=a(0,"boss_icon");x.appendChild(n)}}D.addEventListener("click",F(()=>{e.line_length-=1,i(e.scene.id)},300));const Y=a("btn_return","ui_btns"),m=a("btn_bag","ui_btns"),j=a("btn_left","ui_btns"),A=a("btn_right","ui_btns"),ee=()=>{u.append(m)},te=()=>{u.append(Y,m)};Y.addEventListener("click",()=>{l(e.last_id)});const ne=()=>{u.append(j,A,m)};j.addEventListener("click",()=>{e.wall>1?e.wall-=1:e.wall=4,l(e.scene.id)});A.addEventListener("click",()=>{e.wall<4?e.wall+=1:e.wall=1,l(e.scene.id)});const se=()=>{$.appendChild(J),R.append(L,x,w,$,g,I),u.appendChild(R)};I.addEventListener("click",()=>V());T.addEventListener("click",()=>{e.wall=1,l(0,e.scene_arr)});const y=a("bag_div"),f=a("bag_slots","bag_slots_close"),_=a("bag_view"),P=a("bag_slots_btn"),W=a("bag_key_btn"),h={0:{bg:"bag_map",type:"map"},1:{bg:"bag_key_0",type:"key",door:"s1-2",next:3},2:{bg:"bag_key_1",type:"key",door:"s1-3-2",next:4}};let C=!1,E=!1;m.addEventListener("click",F(()=>{C?X.removeChild(y):z(),C=!C},300));const z=()=>{y.innerHTML="",f.innerHTML="",y.append(_,f,P),e.bag.forEach((t,n)=>{console.log(t);const s=a(h[t].bg,"bag_icon");s.draggable=!0,le(s,t),f.appendChild(s),s.addEventListener("click",()=>{_.innerHTML="",_.className!==h[t].bg?(_.className=h[t].bg,h[t].type==="key"&&(_.appendChild(W),e.key.door=h[t].door,e.key.next=h[t].next)):_.className=""})}),X.appendChild(y)};P.addEventListener("click",()=>{E?ae():ce()});W.addEventListener("click",()=>{b.className===e.key.door&&(l(e.key.next),m.click())});const ae=()=>{E=!1,_.style.height="100%",f.className="bag_slots_close"},ce=()=>{E=!0,_.style.height="0%",f.className="bag_slots_open"};let r=null,k=null;function le(t,n){t.addEventListener("touchstart",function(s){if(!E)return;r=t,k=n;const c=t.getBoundingClientRect();s.targetTouches[0].clientX-c.left,s.targetTouches[0].clientY-c.top}),t.addEventListener("touchmove",function(s){if(!r)return;const c=s.targetTouches[0];r.style.position="absolute",r.style.left=c.pageX+"px",r.style.top=c.pageY+"px"}),t.addEventListener("touchend",function(s){if(!r)return;const c=Math.floor((s.changedTouches[0].pageX-f.offsetLeft)/r.offsetWidth),d=Math.max(0,Math.min(e.bag.length-1,c)),o=e.bag[k];e.bag[k]=e.bag[d],e.bag[d]=o,z(),r=null,k=null,console.log(e.bag)})}function a(t,n,s){const c=document.createElement("div");return t&&(c.id=t),n&&(c.className=n),c}function F(t,n=100){let s;return(...c)=>{clearTimeout(s),s=setTimeout(()=>t.apply(this,c),n)}}export{G as click_ux,i as new_line,l as new_scene,S as render_ux,e as user};
