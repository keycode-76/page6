import{a as W,b as B,c as ie,M as E,d as F,e as de,f as Q,g as L,h as _e}from"./sound-Gwtqw6iZ.js";let e={golbal_arr:{},scene_arr:{},line_arr:[],close_arr:{},note_arr:[],last_id:0,line_id:0,line_length:0,wall:1,scene:[],line:[],bag:[0],key:{door:"",next:"",id:0},boss:0,heart:0,qte:0};const w=document.querySelector("#screen"),u=document.querySelector("#screen_ui"),j=document.querySelector("#screen_bg"),G=document.querySelector("#scene_ux"),r=document.querySelector("#scene_bg"),J=document.querySelector("#set_btn"),y=l("pop_note"),be=l("next_scene_btn"),X=document.querySelector("#end_div"),ge=document.querySelector("#end_content"),ue=document.querySelector("#end_share"),K=document.querySelector("#end_retry"),m=l("lines_div"),P=l("lines_btn"),A=l("lines_name"),d=(n,t)=>{var s;if(r.innerHTML="",G.innerHTML="",u.innerHTML="",C&&v.click(),t?e.scene=t[n]:e.scene=e.scene_arr[n],!!e.scene)switch(e.scene.bg&&(r.className=e.scene.bg),e.line_arr[n]&&(e.line_length=e.line_arr[n].length),e.scene.sound&&(e.scene.sound.currentTime=0,e.scene.sound.play()),e.scene.type){case"anim":V(),r.addEventListener("animationend",a=>{a.animationName===e.scene.bg&&e.scene.type==="anim"&&(r.className="",d(e.scene.next))});break;case"line":b(n);break;case"close":e.line_length=0,b(n);break;case"view":e.last_id=n,b(n);break;case"room":e.last_id=n,r.className=`${e.scene.bg}-${e.wall}`,(s=e.line_arr[n])!=null&&s[e.wall]?(e.line_length=e.line_arr[n][e.wall].length,b(e.wall,e.line_arr[n])):b(n);break;case"qte":e.qte=0,r.className=`${e.scene.bg}-0`,b(n);break;case"end":r.addEventListener("animationend",a=>{e.scene&&e.scene.type==="end"&&a.animationName===e.scene.bg&&(e.golbal_arr.now_end=e.scene.end,e.scene.scene?e.golbal_arr.now_scene=e.scene.scene:e.golbal_arr.now_scene+=1,be.click())});break}},b=(n,t,s)=>{var a;if(u.innerHTML="",t?e.line=t[n]:e.scene.type==="room"||(e.line=e.line_arr[n]),e.line&&e.line_length>0)m.innerHTML="",m.textContent=e.line[e.line_id],s&&(A.textContent=s,m.appendChild(A)),m.appendChild(P),u.appendChild(m),e.line_id+=1,e.line_length-=1,W.currentTime="",W.play();else switch(e.line_id=0,e.scene.type){case"line":V(),d(e.scene.next);break;case"close":$(),Le();break;case"view":e.line_arr[n]&&delete e.line_arr[n],$(),ke();break;case"room":(a=e.line_arr[n])!=null&&a[e.wall]&&delete e.line_arr[n][e.wall],$(),xe();break;case"qte":e.line_arr[n]&&delete e.line_arr[n],pe(),ne(),qe();break}},$=()=>{let n=e.scene.ux;e.scene.type==="room"&&(n=e.scene.ux[e.wall-1]),n.forEach(t=>{if(t.type==="item"&&e.bag.includes(t.is))return;const s=document.createElement("div");s.className="btns_ux",G.appendChild(s),s.style.left=t.x+"vh",s.style.top=t.y+"vh",s.style.width=t.w+"vh",s.style.height=t.h+"vh",t.bg&&s.classList.add(t.bg),s.addEventListener("click",a=>{he(a,t)})})},he=(n,t)=>{switch(B.currentTime=0,B.play(),t.type){case"note":e.line_length=e.note_arr[t.is].length,b(t.is,e.note_arr),e.line_id=0;break;case"close":d(t.is,e.close_arr);break;case"next":t.wall&&(e.wall=t.wall),d(t.is);break;case"item":e.bag.push(t.is),R("item",e.golbal_arr.item[t.is].name),n.target.style.display="none";break;case"npc":t.name,e.line_length=e.note_arr[t.is].length,b(t.is,e.note_arr,t.name);break}},V=()=>{if(e.scene.change)e.scene.change.forEach(n=>{n.wall?n.ux==="add"?e.scene_arr[n.id].ux[n.wall-1].push(n.add):(e.scene_arr[n.id].ux[n.wall-1][n.ux].type=n.type,e.scene_arr[n.id].ux[n.wall-1][n.ux].is=n.is):n.ux==="add"?e.scene_arr[n.id].ux.push(n.add):(e.scene_arr[n.id].ux[n.ux].type=n.type,e.scene_arr[n.id].ux[n.ux].is=n.is)});else return},R=(n,t)=>{switch(w.appendChild(y),n){case"item":y.textContent=`${t} ${e.golbal_arr.pop.item}`,ie.play();break;case"door":y.textContent=e.golbal_arr.pop.door;break}};y.addEventListener("animationend",n=>{n.animationName==="show_anim"&&w.removeChild(y)});const O=l("qte_div"),Z=l("qte_btn","ui_btns"),ee=l("qte_bar"),U=l("qte_box"),h=l("qte_dot"),T=l("feedback","gmui_btns"),p=l("userHeart"),S=l("bossHeart");let fe=0;function pe(){p.innerHTML="",S.innerHTML="",e.boss=e.scene.boss,e.heart=e.scene.user,ee.style.width=`${e.scene.bar}%`;for(let n=0;n<e.heart;n++){const t=l(0,"heart_icon");p.appendChild(t)}for(let n=0;n<e.boss;n++){const t=l(0,"boss_icon");S.appendChild(t)}E.currentTime=0,E.play()}function ne(){fe=Date.now(),h.className="qte_start_anim",T.textContent=e.golbal_arr.qte}function me(){const t=window.getComputedStyle(h).transform;h.className="",h.style.transform=t}function ye(n,t){const s=n.getBoundingClientRect(),a=t.getBoundingClientRect();return s.left>=a.left&&s.right<=a.right}function we(){const n=document.querySelector("#qte_bar");ye(h,n)?(T.textContent=e.golbal_arr.success,e.boss-=1,e.qte+=1,e.scene.mode==="fight"&&(r.className=`${e.scene.bg}-heart`),Y("boss",S,e.boss),Q.currentTime=0,L.currentTime=0,Q.play(),L.play()):(T.textContent=e.golbal_arr.failed,e.heart-=1,e.scene.mode==="fight"&&(r.className=`${e.scene.bg}-boss`),Y("heart",p,e.heart),L.currentTime=0,L.play()),me()}function Y(n,t,s){const a=t.querySelectorAll(`.${n}_icon`),_=a.length-s;if(_>0)for(let o=0;o<_;o++){const g=a[a.length-1-o];g.classList.add("heart_out_anim"),g.addEventListener("animationend",()=>{g.remove(),e.boss<1?(e.scene.reward&&(e.bag.push(e.scene.reward),R("item",e.golbal_arr.item[e.scene.reward].name)),d(e.scene.next),E.pause(),w.removeChild(p)):e.heart<1?(d(e.scene.end),E.pause(),w.removeChild(p)):(e.scene.mode==="run"?n==="boss"&&(r.className=`${e.scene.bg}-${e.qte}`):e.scene.mode==="fight"&&(r.className=`${e.scene.bg}-0`),ne())})}else if(_<0)for(let o=0;o<Math.abs(_);o++){const g=l(n,`${n}-icon`);t.appendChild(g)}}K.addEventListener("click",()=>{});let D=!1;J.addEventListener("click",z(()=>{ve()},300));const ve=()=>{D?X.style.zIndex=-1:(X.style.zIndex=1,J.style.zIndex=2,ge.textContent=e.golbal_arr.end[0][0],ue.textContent=e.golbal_arr.end[0][1],K.textContent=""),D=!D},te=l("btn_return","ui_btns"),v=l("btn_bag","ui_btns"),se=l("btn_left","ui_btns"),ae=l("btn_right","ui_btns");P.addEventListener("click",z(()=>{b(e.scene.id)},300));const ke=()=>{u.append(v)},Le=()=>{u.append(te,v)};te.addEventListener("click",()=>{d(e.last_id),N()});const xe=()=>{u.append(se,ae,v)};se.addEventListener("click",()=>{e.wall>1?e.wall-=1:e.wall=4,d(e.scene.id),N()});ae.addEventListener("click",()=>{e.wall<4?e.wall+=1:e.wall=1,d(e.scene.id),N()});const qe=()=>{U.appendChild(ee),O.append(S,T,U,h,Z),u.appendChild(O),w.appendChild(p)};Z.addEventListener("click",()=>we());const N=()=>{F.currentTime=0,F.play()},q=l("bag_div"),f=l("bag_slots","bag_slots_close"),c=l("bag_view"),M=l(0,"bag_slots_btn_close"),I=l("bag_key_btn");let C=!1,k=!1;v.addEventListener("click",z(()=>{C?(j.removeChild(q),N()):(ce(),le(),_e.play()),C=!C},300));const le=()=>{q.innerHTML="",f.innerHTML="",c.innerHTML="",c.classList="",q.append(c,f,M),e.bag.forEach((n,t)=>{const s=l(e.golbal_arr.item[n].bg,"bag_icon");s.draggable=!0,Ee(s,n),f.appendChild(s),s.addEventListener("click",()=>{k||(c.innerHTML="",I.textContent=e.golbal_arr.use,c.className!==e.golbal_arr.item[n].bg?(c.className=e.golbal_arr.item[n].bg,e.golbal_arr.item[n].type==="key"&&(c.appendChild(I),e.key.door=e.golbal_arr.item[n].door,e.key.next=e.golbal_arr.item[n].next,e.key.id=n)):c.className="")})}),j.appendChild(q)};M.addEventListener("click",()=>{k?ce():Ce()});I.addEventListener("click",()=>{de.play(),r.className===e.key.door?(d(e.key.next),e.bag=e.bag.filter(n=>n!==e.key.id),e.wall=1):R("door")});const ce=()=>{k=!1,c.style.height="100%",f.className="bag_slots_close",M.classList="bag_slots_btn_close"},Ce=()=>{k=!0,c.style.height="0%",c.innerHTML="",c.classList="",f.className="bag_slots_open",M.classList="bag_slots_btn_open"};let i=null,x=null;function Ee(n,t){n.addEventListener("touchstart",function(s){k&&(i=n,x=t)}),n.addEventListener("touchmove",function(s){if(!i)return;i.style.position="absolute";var a=s.targetTouches[0];const _=parseFloat(window.getComputedStyle(i).width),o=parseFloat(window.getComputedStyle(i).height);i.style.left=a.screenX-window.innerWidth/2+_*1.2+"px",i.style.top=a.screenY-window.innerHeight/2+o*1.2+"px"}),n.addEventListener("touchend",function(s){if(!i)return;const a=Math.floor((s.changedTouches[0].pageX-f.offsetLeft)/i.offsetWidth),_=Math.max(0,Math.min(e.bag.length-1,a)),o=e.bag[x];e.bag[x]=e.bag[_],e.bag[_]=o;const g=e.bag.filter((H,re,oe)=>H!==void 0&&H!==""&&oe.indexOf(H)===re);e.bag=g,le(),i=null,x=null})}function l(n,t,s){const a=document.createElement("div");return n&&(a.id=n),t&&(a.className=t),a}function z(n,t=100){let s;return(...a)=>{clearTimeout(s),s=setTimeout(()=>n.apply(this,a),t)}}export{he as click_ux,K as end_retry,b as new_line,d as new_scene,be as next_scene_btn,$ as render_ux,e as user};
